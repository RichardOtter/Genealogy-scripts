-- see "Genealogy\repo Genealogy-scripts\RM\Misc SQL\Format Citation Reference Note after paste from MyHeritage.sql"
-- for the formatting script
-- do the save to aux table before the formatting is done
-- confirm that the Format Citation, above, does only what is desited.


-- ======================================================================DIV80==
-- Create the table

CREATE TABLE IF NOT EXISTS AuxCitationTable (
AuxCitationID INTEGER PRIMARY KEY,
SavedActualText TEXT,
UTCModDate FLOAT,
FOREIGN KEY (AuxCitationID) REFERENCES CitationTable(CitationID)
    ON DELETE CASCADE
);

-- ======================================================================DIV80==

-- This table is storage for dta that will be automatically edited/formatted
-- Storing the data here, before it is auto-edited, allows reversion.

-- This populates the AuxCitationTable with data from the CitationTable.
-- Only the ActualText column is saved.
-- Only data from citations that are to MyHeritage sources are saved.
-- These data are saved once. After they are edited in the CitationTable,
-- they are taggeg with _AUOTEDIT-2025-MM-DD and thus no longer copied
-- in future invocations


DROP VIEW IF EXISTS Unmod_Citations_to_MyHr;

CREATE TEMP VIEW Unmod_Citations_to_MyHr AS
SELECT CitationID
FROM CitationTable AS ct
INNER JOIN SourceTable AS st ON ct.SourceID = st.SourceID
WHERE st.Name LIKE 'RRdb MyHr%' COLLATE NOCASE
AND ct.ActualText NOT LIKE '%\_AUTOEDIT-2025%' ESCAPE '\';


-- save original note text
INSERT OR IGNORE INTO AuxCitationTable (AuxCitationID, SavedActualText, UTCModDate)
SELECT CitationID, ActualText, UTCModDate
FROM CitationTable
WHERE  CitationID IN (SELECT CitationID FROM Unmod_Citations_to_MyHr);

