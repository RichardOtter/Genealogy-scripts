

--  AuxDNATable
CREATE TABLE AuxDNATable (
AuxDNATableID INTEGER PRIMARY KEY,
Sort1 INTEGER,
Sort2 INTEGER,
UTCModDate FLOAT,
FOREIGN KEY (AuxDNATableID) REFERENCES DNATable(RecID)
    ON DELETE CASCADE
);

--  AuxDNATable trigger
CREATE TRIGGER IF NOT EXISTS AuxDNATable_UTCModDate
AFTER UPDATE ON AuxDNATable
FOR EACH ROW
BEGIN
  UPDATE AuxDNATable
  SET UTCModDate = julianday('now') - 2415018.5
  WHERE rowid = NEW.rowid;
END;


--  DNATable trigger
CREATE TRIGGER DNATable_AuxDNATable
AFTER INSERT ON DNATable
FOR EACH ROW
BEGIN
  INSERT OR IGNORE INTO AuxDNATable
         (AuxDNATableID, Sort1, Sort2, Info, UTCModDate)
  VALUES (
     NEW.RecID,
     CAST(ROUND(NEW.SharedCM, 2) * 10 AS INT),
     999999,
     NULL,
     julianday('now') - 2415018.5
  );
END;


--  AuxMultimediaTable
CREATE TABLE IF NOT EXISTS AuxMultimediaTable (
AuxMediaID INTEGER PRIMARY KEY,
FileSize INTEGER,
FileTimeCreation FLOAT,
FileTimeModification FLOAT,
HashType TEXT,
Hash TEXT,
UTCModDate FLOAT,
FOREIGN KEY (AuxMediaID) REFERENCES MultimediaTable(MediaID)
    ON DELETE CASCADE
);

--  AuxMultimediaTable trigger
CREATE TRIGGER IF NOT EXISTS AuxMultimediaTable_UTCModDate
AFTER UPDATE ON AuxMultimediaTable
FOR EACH ROW
BEGIN
  UPDATE AuxMultimediaTable
  SET UTCModDate = julianday('now') - 2415018.5
  WHERE rowid = NEW.rowid;
END;



--  AuxCitationLinkTable
CREATE TABLE IF NOT EXISTS AuxCitationLinkTable (
AuxLinkID INTEGER PRIMARY KEY,
CitationID INTEGER,
OwnerType INTEGER,
OwnerID INTEGER,
SortOrder INTEGER,
HiddenSet INTEGER,
Quality TEXT,
IsPrivate INTEGER,
Flags INTEGER,
UTCModDate FLOAT
);

=========================================================================DIV80==
explanation

The constraint:
FOREIGN KEY (AuxDNATableID) REFERENCES DNATable(RecID)
    ON DELETE CASCADE

ensures that when a row in the main table is deleted, the corresponding row
in the aux table is also deleted.

tested-  delete a row in dnatable, the corresponding row in aux dna table is deleted.
if delete row in aux dna table, nothing happens in dnatable.



=========================================================================DIV80==
For backup-
see-
DB schema changes\Extract and Backup aux tables.py


For restore-
write utility if it is needed

-- restore saved citation note to CitationTable
UPDATE CitationTable 
SET ActualText = SavedActualText
FROM AuxCitationTable 
WHERE  CitationID = AuxCitationID;


=========================================================================DIV80==
Remove Aux tables
Don't drop the tables unless exported

DROP TABLE IF EXIST AuxDNATable;
DROP TRIGGER IF EXIST DNATable_AuxDNATable;
DROP TABLE IF EXIST AuxMultimediaTable;
DROP TABLE IF EXIST AuxCitationLinkTable;

=========================================================================DIV80==

